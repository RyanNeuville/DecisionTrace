generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * --- GESTION UTILISATEURS & SAAS ---
 */

model User {
  id             String        @id @default(cuid())
  clerkId        String        @unique // Pour l'intégration avec Clerk
  email          String        @unique
  name           String?
  image          String?
  role           UserRole      @default(USER)
  /**
   * Relations
   */
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  decisions      Decision[]
  transactions   Transaction[]
  actionLogs     ActionLog[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Organization {
  id                 String             @id @default(cuid())
  name               String
  slug               String             @unique
  /**
   * Gestion de l'abonnement (20 000 FCFA/mois)
   */
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  subscriptionId     String?            @unique
  users              User[]
  decisions          Decision[]
  transactions       Transaction[]
  createdAt          DateTime           @default(now())
}

/**
 * --- MODULE 1 : GESTION DES DÉCISIONS ---
 */

model Decision {
  id             String         @id @default(cuid())
  title          String
  context        String         @db.Text
  responsible    String
  status         DecisionStatus @default(DRAFT)
  justification  String?        @db.Text
  options        Option[]
  criteria       Criteria[]
  predictedCost  Decimal?       @db.Decimal(12, 2)
  transactions   Transaction[]
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Option {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  isWinner    Boolean      @default(false)
  decisionId  String
  decision    Decision     @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  evaluations Evaluation[]

  @@index([decisionId])
}

model Criteria {
  id          String       @id @default(cuid())
  name        String
  weight      Int          @default(1)
  decisionId  String
  decision    Decision     @relation(fields: [decisionId], references: [id], onDelete: Cascade)
  evaluations Evaluation[]

  @@index([decisionId])
}

model Evaluation {
  id         String   @id @default(cuid())
  score      Int
  comment    String?  @db.Text
  optionId   String
  option     Option   @relation(fields: [optionId], references: [id], onDelete: Cascade)
  criteriaId String
  criteria   Criteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@unique([optionId, criteriaId])
}

/**
 * --- MODULE 2 : GESTION FINANCIÈRE ---
 */

model Transaction {
  id             String          @id @default(cuid())
  type           TransactionType
  amount         Decimal         @db.Decimal(12, 2)
  category       String
  description    String?
  date           DateTime        @default(now())
  decisionId     String?
  decision       Decision?       @relation(fields: [decisionId], references: [id])
  userId         String
  user           User            @relation(fields: [userId], references: [id])
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id])

  @@index([decisionId])
}

/**
 * --- LOGS & AUDIT ---
 */

model ActionLog {
  id        String   @id @default(cuid())
  action    String
  details   Json?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

/**
 * --- ENUMS ---
 */

enum UserRole {
  ADMIN
  USER
}

enum DecisionStatus {
  DRAFT
  IN_PROGRESS
  VALIDATED
  REJECTED
  ARCHIVED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}
